{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/Users/kishonst.clair/Desktop/PortfolioWebsite/kishon-portfolio-website/node_modules/@babel/runtime/regenerator\");\n\nvar _slicedToArray = require(\"/Users/kishonst.clair/Desktop/PortfolioWebsite/kishon-portfolio-website/node_modules/@babel/runtime/helpers/slicedToArray\");\n\nvar _classCallCheck = require(\"/Users/kishonst.clair/Desktop/PortfolioWebsite/kishon-portfolio-website/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/kishonst.clair/Desktop/PortfolioWebsite/kishon-portfolio-website/node_modules/@babel/runtime/helpers/createClass\");\n\nvar _asyncToGenerator = require(\"/Users/kishonst.clair/Desktop/PortfolioWebsite/kishon-portfolio-website/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nexports.__esModule = true;\nexports[\"default\"] = void 0;\n\nvar _escapeStringRegexp = _interopRequireDefault(require(\"next/dist/compiled/escape-string-regexp\"));\n\nvar _nodeHtmlParser = require(\"node-html-parser\");\n\nvar _constants = require(\"./constants\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n} // const MIDDLEWARE_TIME_BUDGET = parseInt(process.env.__POST_PROCESS_MIDDLEWARE_TIME_BUDGET || '', 10) || 10\n\n\nvar MAXIMUM_IMAGE_PRELOADS = 2;\nvar IMAGE_PRELOAD_SIZE_THRESHOLD = 2500;\nvar middlewareRegistry = [];\n\nfunction registerPostProcessor(name, middleware, condition) {\n  middlewareRegistry.push({\n    name: name,\n    middleware: middleware,\n    condition: condition || null\n  });\n}\n\nfunction processHTML(_x, _x2, _x3) {\n  return _processHTML.apply(this, arguments);\n}\n\nfunction _processHTML() {\n  _processHTML = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(html, data, options) {\n    var root, document, callMiddleWare, _callMiddleWare, i, middleware;\n\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            _callMiddleWare = function _callMiddleWare3() {\n              _callMiddleWare = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(middleware) {\n                var inspectData;\n                return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n                  while (1) {\n                    switch (_context3.prev = _context3.next) {\n                      case 0:\n                        // let timer = Date.now()\n                        inspectData = middleware.inspect(root, data);\n                        _context3.next = 3;\n                        return middleware.mutate(document, inspectData, data);\n\n                      case 3:\n                        document = _context3.sent;\n                        return _context3.abrupt(\"return\");\n\n                      case 5:\n                      case \"end\":\n                        return _context3.stop();\n                    }\n                  }\n                }, _callee3);\n              }));\n              return _callMiddleWare.apply(this, arguments);\n            };\n\n            callMiddleWare = function _callMiddleWare2(_x9) {\n              return _callMiddleWare.apply(this, arguments);\n            };\n\n            if (middlewareRegistry[0]) {\n              _context4.next = 4;\n              break;\n            }\n\n            return _context4.abrupt(\"return\", html);\n\n          case 4:\n            root = (0, _nodeHtmlParser.parse)(html);\n            document = html; // Calls the middleware, with some instrumentation and logging\n\n            i = 0;\n\n          case 7:\n            if (!(i < middlewareRegistry.length)) {\n              _context4.next = 15;\n              break;\n            }\n\n            middleware = middlewareRegistry[i];\n\n            if (!(!middleware.condition || middleware.condition(options))) {\n              _context4.next = 12;\n              break;\n            }\n\n            _context4.next = 12;\n            return callMiddleWare(middlewareRegistry[i].middleware);\n\n          case 12:\n            i++;\n            _context4.next = 7;\n            break;\n\n          case 15:\n            return _context4.abrupt(\"return\", document);\n\n          case 16:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  }));\n  return _processHTML.apply(this, arguments);\n}\n\nvar FontOptimizerMiddleware = /*#__PURE__*/function () {\n  function FontOptimizerMiddleware() {\n    _classCallCheck(this, FontOptimizerMiddleware);\n\n    this.mutate = /*#__PURE__*/function () {\n      var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(markup, fontDefinitions, options) {\n        var result;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                result = markup;\n\n                if (options.getFontDefinition) {\n                  _context.next = 3;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", markup);\n\n              case 3:\n                fontDefinitions.forEach(function (fontDef) {\n                  var _fontDef = _slicedToArray(fontDef, 2),\n                      url = _fontDef[0],\n                      nonce = _fontDef[1];\n\n                  var fallBackLinkTag = \"<link rel=\\\"stylesheet\\\" href=\\\"\".concat(url, \"\\\"/>\");\n\n                  if (result.indexOf(\"<style data-href=\\\"\".concat(url, \"\\\">\")) > -1 || result.indexOf(fallBackLinkTag) > -1) {\n                    // The font is already optimized and probably the response is cached\n                    return;\n                  }\n\n                  var fontContent = options.getFontDefinition ? options.getFontDefinition(url) : null;\n\n                  if (!fontContent) {\n                    /**\n                    * In case of unreachable font definitions, fallback to default link tag.\n                    */\n                    result = result.replace('</head>', \"\".concat(fallBackLinkTag, \"</head>\"));\n                  } else {\n                    var nonceStr = nonce ? \" nonce=\\\"\".concat(nonce, \"\\\"\") : '';\n                    result = result.replace('</head>', \"<style data-href=\\\"\".concat(url, \"\\\"\").concat(nonceStr, \">\").concat(fontContent, \"</style></head>\"));\n                  }\n                });\n                return _context.abrupt(\"return\", result);\n\n              case 5:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n\n      return function (_x4, _x5, _x6) {\n        return _ref.apply(this, arguments);\n      };\n    }();\n  }\n\n  _createClass(FontOptimizerMiddleware, [{\n    key: \"inspect\",\n    value: function inspect(originalDom, options) {\n      if (!options.getFontDefinition) {\n        return;\n      }\n\n      var fontDefinitions = []; // collecting all the requested font definitions\n\n      originalDom.querySelectorAll('link').filter(function (tag) {\n        return tag.getAttribute('rel') === 'stylesheet' && tag.hasAttribute('data-href') && _constants.OPTIMIZED_FONT_PROVIDERS.some(function (url) {\n          var dataHref = tag.getAttribute('data-href');\n          return dataHref ? dataHref.startsWith(url) : false;\n        });\n      }).forEach(function (element) {\n        var url = element.getAttribute('data-href');\n        var nonce = element.getAttribute('nonce');\n\n        if (url) {\n          fontDefinitions.push([url, nonce]);\n        }\n      });\n      return fontDefinitions;\n    }\n  }]);\n\n  return FontOptimizerMiddleware;\n}();\n\nvar ImageOptimizerMiddleware = /*#__PURE__*/function () {\n  function ImageOptimizerMiddleware() {\n    _classCallCheck(this, ImageOptimizerMiddleware);\n\n    this.mutate = /*#__PURE__*/function () {\n      var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(markup, imgPreloads) {\n        var result, imagePreloadTags;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                result = markup;\n                imagePreloadTags = imgPreloads.filter(function (imgHref) {\n                  return !preloadTagAlreadyExists(markup, imgHref);\n                }).reduce(function (acc, imgHref) {\n                  return acc + \"<link rel=\\\"preload\\\" href=\\\"\".concat(imgHref, \"\\\" as=\\\"image\\\"/>\");\n                }, '');\n                return _context2.abrupt(\"return\", result.replace(/<link rel=\"preload\"/, \"\".concat(imagePreloadTags, \"<link rel=\\\"preload\\\"\")));\n\n              case 3:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n\n      return function (_x7, _x8) {\n        return _ref2.apply(this, arguments);\n      };\n    }();\n  }\n\n  _createClass(ImageOptimizerMiddleware, [{\n    key: \"inspect\",\n    value: function inspect(originalDom) {\n      var imgPreloads = [];\n      var imgElements = originalDom.querySelectorAll('img');\n      var eligibleImages = [];\n\n      for (var i = 0; i < imgElements.length; i++) {\n        if (isImgEligible(imgElements[i])) {\n          eligibleImages.push(imgElements[i]);\n        }\n\n        if (eligibleImages.length >= MAXIMUM_IMAGE_PRELOADS) {\n          break;\n        }\n      }\n\n      for (var _i = 0, _eligibleImages = eligibleImages; _i < _eligibleImages.length; _i++) {\n        var imgEl = _eligibleImages[_i];\n        var src = imgEl.getAttribute('src');\n\n        if (src) {\n          imgPreloads.push(src);\n        }\n      }\n\n      return imgPreloads;\n    }\n  }]);\n\n  return ImageOptimizerMiddleware;\n}();\n\nfunction isImgEligible(imgElement) {\n  var imgSrc = imgElement.getAttribute('src');\n  return !!imgSrc && sourceIsSupportedType(imgSrc) && imageIsNotTooSmall(imgElement) && imageIsNotHidden(imgElement);\n}\n\nfunction preloadTagAlreadyExists(html, href) {\n  var escapedHref = (0, _escapeStringRegexp[\"default\"])(href);\n  var regex = new RegExp(\"<link[^>]*href[^>]*\".concat(escapedHref));\n  return html.match(regex);\n}\n\nfunction imageIsNotTooSmall(imgElement) {\n  // Skip images without both height and width--we don't know enough to say if\n  // they are too small\n  if (!(imgElement.hasAttribute('height') && imgElement.hasAttribute('width'))) {\n    return true;\n  }\n\n  try {\n    var heightAttr = imgElement.getAttribute('height');\n    var widthAttr = imgElement.getAttribute('width');\n\n    if (!heightAttr || !widthAttr) {\n      return true;\n    }\n\n    if (parseInt(heightAttr) * parseInt(widthAttr) <= IMAGE_PRELOAD_SIZE_THRESHOLD) {\n      return false;\n    }\n  } catch (err) {\n    return true;\n  }\n\n  return true;\n} // Traverse up the dom from each image to see if it or any of it's\n// ancestors have the hidden attribute.\n\n\nfunction imageIsNotHidden(imgElement) {\n  var activeElement = imgElement;\n\n  while (activeElement.parentNode) {\n    if (activeElement.hasAttribute('hidden')) {\n      return false;\n    }\n\n    activeElement = activeElement.parentNode;\n  }\n\n  return true;\n} // Currently only filters out svg images--could be made more specific in the future.\n\n\nfunction sourceIsSupportedType(imgSrc) {\n  return !imgSrc.includes('.svg');\n} // Initialization\n\n\nregisterPostProcessor('Inline-Fonts', new FontOptimizerMiddleware(), // Using process.env because passing Experimental flag through loader is not possible.\n// @ts-ignore\nfunction (options) {\n  return options.optimizeFonts || process.env.__NEXT_OPTIMIZE_FONTS;\n});\nregisterPostProcessor('Preload Images', new ImageOptimizerMiddleware(), // @ts-ignore\nfunction (options) {\n  return options.optimizeImages || process.env.__NEXT_OPTIMIZE_IMAGES;\n});\nvar _default = processHTML;\nexports[\"default\"] = _default;","map":{"version":3,"sources":["../../../next-server/lib/post-process.ts"],"names":["MAXIMUM_IMAGE_PRELOADS","IMAGE_PRELOAD_SIZE_THRESHOLD","middlewareRegistry","name","middleware","condition","root","document","inspectData","i","callMiddleWare","FontOptimizerMiddleware","inspect","options","fontDefinitions","originalDom","tag","OPTIMIZED_FONT_PROVIDERS","url","dataHref","element","nonce","result","fontDef","fallBackLinkTag","fontContent","nonceStr","ImageOptimizerMiddleware","imgPreloads","imgElements","eligibleImages","isImgEligible","imgEl","src","imagePreloadTags","imgHref","preloadTagAlreadyExists","acc","imgSrc","imgElement","sourceIsSupportedType","imageIsNotTooSmall","imageIsNotHidden","escapedHref","regex","html","heightAttr","widthAttr","parseInt","activeElement","registerPostProcessor","process","processHTML"],"mappings":";;;;;;;;;;;;;;;AAAA,IAAA,mBAAA,GAAA,sBAAA,CAAA,OAAA,CAAA,yCAAA,CAAA,CAAA;;AACA,IAAA,eAAA,GAAA,OAAA,CAAA,kBAAA,CAAA;;AACA,IAAA,UAAA,GAAA,OAAA,CAAA,aAAA,CAAA;;;;;;AAEA,C,CAAA;;;AACA,IAAMA,sBAAsB,GAA5B,CAAA;AACA,IAAMC,4BAA4B,GAAlC,IAAA;AAqBA,IAAMC,kBAA8C,GAApD,EAAA;;AAEA,SAAA,qBAAA,CAAA,IAAA,EAAA,UAAA,EAAA,SAAA,EAIE;AACAA,EAAAA,kBAAkB,CAAlBA,IAAAA,CAAwB;AAAEC,IAAAA,IAAF,EAAEA,IAAF;AAAQC,IAAAA,UAAR,EAAQA,UAAR;AAAoBC,IAAAA,SAAS,EAAEA,SAAS,IAAhEH;AAAwB,GAAxBA;AAGF;;SAAA,W;;;;;0EAAA,kBAAA,IAAA,EAAA,IAAA,EAAA,OAAA;AAAA,wBAYE,cAZF;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yFAYE,kBAAA,UAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACE;AACMM,wBAAAA,WAFR,GAEsBJ,UAAU,CAAVA,OAAAA,CAAAA,IAAAA,EAApB,IAAoBA,CAFtB;AAAA;AAAA,+BAGmBA,UAAU,CAAVA,MAAAA,CAAAA,QAAAA,EAAAA,WAAAA,EAAjBG,IAAiBH,CAHnB;;AAAA;AAGEG,wBAAAA,QAHF;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAZF;AAAA;AAAA;;AAYE,YAAA,cAZF;AAAA;AAAA;;AAAA,gBAMOL,kBAAkB,CAAvB,CAAuB,CANzB;AAAA;AAAA;AAAA;;AAAA,8CAOI,IAPJ;;AAAA;AASQI,YAAAA,IATR,GAS4B,CAAA,GAAA,eAAA,CAAA,KAAA,EAA1B,IAA0B,CAT5B;AAUMC,YAAAA,QAVN,GAUE,IAVF,EAWE;;AAaSE,YAAAA,CAxBX,GAwBE,CAxBF;;AAAA;AAAA,kBAwBkBA,CAAC,GAAGP,kBAAkB,CAAtC,MAxBF;AAAA;AAAA;AAAA;;AAyBQE,YAAAA,UAzBR,GAyBqBF,kBAAkB,CAAnC,CAAmC,CAzBvC;;AAAA,kBA0BQ,CAACE,UAAU,CAAX,SAAA,IAAyBA,UAAU,CAAVA,SAAAA,CAA7B,OAA6BA,CA1BjC;AAAA;AAAA;AAAA;;AAAA;AAAA,mBA2BYM,cAAc,CAACR,kBAAkB,CAAlBA,CAAkB,CAAlBA,CAArB,UAAoB,CA3B1B;;AAAA;AAwBiDO,YAAAA,CAA/C,EAxBF;AAAA;AAAA;;AAAA;AAAA,8CA+BE,QA/BF;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;IAkCME,uB;AAAyD,qCAAA;AAAA;;AAAA,SAAA,MAAA;AAAA,0EA6BpD,iBAAA,MAAA,EAAA,eAAA,EAAA,OAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAKHW,gBAAAA,MALG,GAKP,MALO;;AAAA,oBAMFT,OAAO,CAAZ,iBANO;AAAA;AAAA;AAAA;;AAAA,iDAOL,MAPK;;AAAA;AAUP,gBAAA,eAAe,CAAf,OAAA,CAAyBU,UAAAA,OAAD,EAAa;AAAA,gDACnC,OADmC;AAAA,sBAC7B,GAD6B;AAAA,sBAC7B,KAD6B;;AAEnC,sBAAMC,eAAe,6CAArB,GAAqB,SAArB;;AACA,sBACEF,MAAM,CAANA,OAAAA,8BAAAA,GAAAA,YAA+C,CAA/CA,CAAAA,IACAA,MAAM,CAANA,OAAAA,CAAAA,eAAAA,IAAkC,CAFpC,CAAA,EAGE;AACA;AACA;AAEF;;AAAA,sBAAMG,WAAW,GAAGZ,OAAO,CAAPA,iBAAAA,GAChBA,OAAO,CAAPA,iBAAAA,CADgBA,GAChBA,CADgBA,GAApB,IAAA;;AAGA,sBAAI,CAAJ,WAAA,EAAkB;AAChB;AACR;AACA;AACQS,oBAAAA,MAAM,GAAGA,MAAM,CAANA,OAAAA,CAAAA,SAAAA,YAATA,eAASA,aAATA;AAJF,mBAAA,MAKO;AACL,wBAAMI,QAAQ,GAAGL,KAAK,sBAAA,KAAA,UAAtB,EAAA;AACAC,oBAAAA,MAAM,GAAGA,MAAM,CAANA,OAAAA,CAAAA,SAAAA,+BAEcJ,GAFdI,eAEqBI,QAFrBJ,cAATA,WAASA,qBAATA;AAKH;AAzBD,iBAAA;AAVO,iDA7BoD,MA6BpD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OA7BoD;;AAAA;AAAA;AAAA;AAAA;AAC7DV;;;;4BAAO,W,EAAA,O,EAAmD;AACxD,UAAI,CAACC,OAAO,CAAZ,iBAAA,EAAgC;AAC9B;AAEF;;AAAA,UAAMC,eAAyC,GAA/C,EAAA,CAJwD,CAKxD;;AACAC,MAAAA,WAAW,CAAXA,gBAAAA,CAAAA,MAAAA,EAAAA,MAAAA,CAGKC,UAAAA,GAAD;AAAA,eACEA,GAAG,CAAHA,YAAAA,CAAAA,KAAAA,MAAAA,YAAAA,IACAA,GAAG,CAAHA,YAAAA,CADAA,WACAA,CADAA,IAEAC,UAAAA,CAAAA,wBAAAA,CAAAA,IAAAA,CAA+BC,UAAAA,GAAD,EAAS;AACrC,cAAMC,QAAQ,GAAGH,GAAG,CAAHA,YAAAA,CAAjB,WAAiBA,CAAjB;AACA,iBAAOG,QAAQ,GAAGA,QAAQ,CAARA,UAAAA,CAAH,GAAGA,CAAH,GAAf,KAAA;AARRJ,SAMME,CAHF;AAAA,OAHJF,EAAAA,OAAAA,CAWYK,UAAAA,OAAD,EAA0B;AACjC,YAAMF,GAAG,GAAGE,OAAO,CAAPA,YAAAA,CAAZ,WAAYA,CAAZ;AACA,YAAMC,KAAK,GAAGD,OAAO,CAAPA,YAAAA,CAAd,OAAcA,CAAd;;AAEA,YAAA,GAAA,EAAS;AACPN,UAAAA,eAAe,CAAfA,IAAAA,CAAqB,CAAA,GAAA,EAArBA,KAAqB,CAArBA;AAEH;AAlBHC,OAAAA;AAoBA,aAAA,eAAA;AA3B2D;;;;;;IAsEzDY,wB;AAA0D,sCAAA;AAAA;;AAAA,SAAA,MAAA;AAAA,2EAuBrD,kBAAA,MAAA,EAAA,WAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACHL,gBAAAA,MADG,GACP,MADO;AAEHY,gBAAAA,gBAFG,GAEgBN,WAAW,CAAXA,MAAAA,CACZO,UAAAA,OAAD;AAAA,yBAAa,CAACC,uBAAuB,CAAA,MAAA,EADxBR,OACwB,CAArC;AAAA,iBADaA,EAAAA,MAAAA,CAGnB,UAAA,GAAA,EAAA,OAAA;AAAA,yBACES,GAAG,0CAJcT,OAId,sBADL;AAAA,iBAHmBA,EAAvB,EAAuBA,CAFhB;AAAA,kDASAN,MAAM,CAANA,OAAAA,CAAAA,qBAAAA,YAhCqD,gBAgCrDA,2BATA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAvBqD;;AAAA;AAAA;AAAA;AAAA;AAC9DV;;;;4BAAO,W,EAA2B;AAChC,UAAMgB,WAAW,GAAjB,EAAA;AACA,UAAMC,WAAW,GAAGd,WAAW,CAAXA,gBAAAA,CAApB,KAAoBA,CAApB;AACA,UAAIe,cAAkC,GAAtC,EAAA;;AACA,WAAK,IAAIrB,CAAC,GAAV,CAAA,EAAgBA,CAAC,GAAGoB,WAAW,CAA/B,MAAA,EAAwCpB,CAAxC,EAAA,EAA6C;AAC3C,YAAIsB,aAAa,CAACF,WAAW,CAA7B,CAA6B,CAAZ,CAAjB,EAAmC;AACjCC,UAAAA,cAAc,CAAdA,IAAAA,CAAoBD,WAAW,CAA/BC,CAA+B,CAA/BA;AAEF;;AAAA,YAAIA,cAAc,CAAdA,MAAAA,IAAJ,sBAAA,EAAqD;AACnD;AAEH;AAED;;AAAA,yCAAA,cAAA,qCAAoC;AAA/B,YAAME,KAAX,sBAAK;AACH,YAAMC,GAAG,GAAGD,KAAK,CAALA,YAAAA,CAAZ,KAAYA,CAAZ;;AACA,YAAA,GAAA,EAAS;AACPJ,UAAAA,WAAW,CAAXA,IAAAA,CAAAA,GAAAA;AAEH;AAED;;AAAA,aAAA,WAAA;AArB4D;;;;;;AAuChE,SAAA,aAAA,CAAA,UAAA,EAAyD;AACvD,MAAIU,MAAM,GAAGC,UAAU,CAAVA,YAAAA,CAAb,KAAaA,CAAb;AACA,SACE,CAAC,CAAD,MAAA,IACAC,qBAAqB,CADrB,MACqB,CADrB,IAEAC,kBAAkB,CAFlB,UAEkB,CAFlB,IAGAC,gBAAgB,CAJlB,UAIkB,CAJlB;AAQF;;AAAA,SAAA,uBAAA,CAAA,IAAA,EAAA,IAAA,EAA6D;AAC3D,MAAMC,WAAW,GAAG,CAAA,GAAA,mBAAA,WAAA,EAApB,IAAoB,CAApB;AACA,MAAMC,KAAK,GAAG,IAAA,MAAA,8BAAd,WAAc,EAAd;AACA,SAAOC,IAAI,CAAJA,KAAAA,CAAP,KAAOA,CAAP;AAGF;;AAAA,SAAA,kBAAA,CAAA,UAAA,EAA8D;AAC5D;AACA;AACA,MACE,EAAEN,UAAU,CAAVA,YAAAA,CAAAA,QAAAA,KAAqCA,UAAU,CAAVA,YAAAA,CADzC,OACyCA,CAAvC,CADF,EAEE;AACA,WAAA,IAAA;AAEF;;AAAA,MAAI;AACF,QAAMO,UAAU,GAAGP,UAAU,CAAVA,YAAAA,CAAnB,QAAmBA,CAAnB;AACA,QAAMQ,SAAS,GAAGR,UAAU,CAAVA,YAAAA,CAAlB,OAAkBA,CAAlB;;AACA,QAAI,CAAA,UAAA,IAAe,CAAnB,SAAA,EAA+B;AAC7B,aAAA,IAAA;AAGF;;AAAA,QACES,QAAQ,CAARA,UAAQ,CAARA,GAAuBA,QAAQ,CAA/BA,SAA+B,CAA/BA,IADF,4BAAA,EAGE;AACA,aAAA,KAAA;AAEH;AAAC,GAbF,CAaE,OAAA,GAAA,EAAY;AACZ,WAAA,IAAA;AAEF;;AAAA,SAAA,IAAA;AAGF,C,CAAA;AACA;;;AACA,SAAA,gBAAA,CAAA,UAAA,EAA4D;AAC1D,MAAIC,aAAa,GAAjB,UAAA;;AACA,SAAOA,aAAa,CAApB,UAAA,EAAiC;AAC/B,QAAIA,aAAa,CAAbA,YAAAA,CAAJ,QAAIA,CAAJ,EAA0C;AACxC,aAAA,KAAA;AAEFA;;AAAAA,IAAAA,aAAa,GAAGA,aAAa,CAA7BA,UAAAA;AAEF;;AAAA,SAAA,IAAA;AAGF,C,CAAA;;;AACA,SAAA,qBAAA,CAAA,MAAA,EAAwD;AACtD,SAAO,CAACX,MAAM,CAANA,QAAAA,CAAR,MAAQA,CAAR;AAGF,C,CAAA;;;AACAY,qBAAqB,CAAA,cAAA,EAEnB,IAFmB,uBAEnB,EAFmB,EAGnB;AACA;AACCrC,UAAAA,OAAD;AAAA,SAAaA,OAAO,CAAPA,aAAAA,IAAyBsC,OAAO,CAAPA,GAAAA,CALxCD,qBAKE;AAAA,CALmB,CAArBA;AAQAA,qBAAqB,CAAA,gBAAA,EAEnB,IAFmB,wBAEnB,EAFmB,EAGnB;AACCrC,UAAAA,OAAD;AAAA,SAAaA,OAAO,CAAPA,cAAAA,IAA0BsC,OAAO,CAAPA,GAAAA,CAJzCD,sBAIE;AAAA,CAJmB,CAArBA;eAOeE,W","sourcesContent":["import escapeRegexp from 'next/dist/compiled/escape-string-regexp'\nimport { parse, HTMLElement } from 'node-html-parser'\nimport { OPTIMIZED_FONT_PROVIDERS } from './constants'\n\n// const MIDDLEWARE_TIME_BUDGET = parseInt(process.env.__POST_PROCESS_MIDDLEWARE_TIME_BUDGET || '', 10) || 10\nconst MAXIMUM_IMAGE_PRELOADS = 2\nconst IMAGE_PRELOAD_SIZE_THRESHOLD = 2500\n\ntype postProcessOptions = {\n  optimizeFonts: boolean\n  optimizeImages: boolean\n}\n\ntype renderOptions = {\n  getFontDefinition?: (url: string) => string\n}\ninterface PostProcessMiddleware {\n  inspect: (originalDom: HTMLElement, options: renderOptions) => any\n  mutate: (markup: string, data: any, options: renderOptions) => Promise<string>\n}\n\ntype middlewareSignature = {\n  name: string\n  middleware: PostProcessMiddleware\n  condition: ((options: postProcessOptions) => boolean) | null\n}\n\nconst middlewareRegistry: Array<middlewareSignature> = []\n\nfunction registerPostProcessor(\n  name: string,\n  middleware: PostProcessMiddleware,\n  condition?: (options: postProcessOptions) => boolean\n) {\n  middlewareRegistry.push({ name, middleware, condition: condition || null })\n}\n\nasync function processHTML(\n  html: string,\n  data: renderOptions,\n  options: postProcessOptions\n): Promise<string> {\n  // Don't parse unless there's at least one processor middleware\n  if (!middlewareRegistry[0]) {\n    return html\n  }\n  const root: HTMLElement = parse(html)\n  let document = html\n  // Calls the middleware, with some instrumentation and logging\n  async function callMiddleWare(middleware: PostProcessMiddleware) {\n    // let timer = Date.now()\n    const inspectData = middleware.inspect(root, data)\n    document = await middleware.mutate(document, inspectData, data)\n    // timer = Date.now() - timer\n    // if (timer > MIDDLEWARE_TIME_BUDGET) {\n    // TODO: Identify a correct upper limit for the postprocess step\n    // and add a warning to disable the optimization\n    // }\n    return\n  }\n\n  for (let i = 0; i < middlewareRegistry.length; i++) {\n    let middleware = middlewareRegistry[i]\n    if (!middleware.condition || middleware.condition(options)) {\n      await callMiddleWare(middlewareRegistry[i].middleware)\n    }\n  }\n\n  return document\n}\n\nclass FontOptimizerMiddleware implements PostProcessMiddleware {\n  inspect(originalDom: HTMLElement, options: renderOptions) {\n    if (!options.getFontDefinition) {\n      return\n    }\n    const fontDefinitions: (string | undefined)[][] = []\n    // collecting all the requested font definitions\n    originalDom\n      .querySelectorAll('link')\n      .filter(\n        (tag: HTMLElement) =>\n          tag.getAttribute('rel') === 'stylesheet' &&\n          tag.hasAttribute('data-href') &&\n          OPTIMIZED_FONT_PROVIDERS.some((url) => {\n            const dataHref = tag.getAttribute('data-href')\n            return dataHref ? dataHref.startsWith(url) : false\n          })\n      )\n      .forEach((element: HTMLElement) => {\n        const url = element.getAttribute('data-href')\n        const nonce = element.getAttribute('nonce')\n\n        if (url) {\n          fontDefinitions.push([url, nonce])\n        }\n      })\n\n    return fontDefinitions\n  }\n  mutate = async (\n    markup: string,\n    fontDefinitions: string[][],\n    options: renderOptions\n  ) => {\n    let result = markup\n    if (!options.getFontDefinition) {\n      return markup\n    }\n\n    fontDefinitions.forEach((fontDef) => {\n      const [url, nonce] = fontDef\n      const fallBackLinkTag = `<link rel=\"stylesheet\" href=\"${url}\"/>`\n      if (\n        result.indexOf(`<style data-href=\"${url}\">`) > -1 ||\n        result.indexOf(fallBackLinkTag) > -1\n      ) {\n        // The font is already optimized and probably the response is cached\n        return\n      }\n      const fontContent = options.getFontDefinition\n        ? options.getFontDefinition(url as string)\n        : null\n      if (!fontContent) {\n        /**\n         * In case of unreachable font definitions, fallback to default link tag.\n         */\n        result = result.replace('</head>', `${fallBackLinkTag}</head>`)\n      } else {\n        const nonceStr = nonce ? ` nonce=\"${nonce}\"` : ''\n        result = result.replace(\n          '</head>',\n          `<style data-href=\"${url}\"${nonceStr}>${fontContent}</style></head>`\n        )\n      }\n    })\n\n    return result\n  }\n}\n\nclass ImageOptimizerMiddleware implements PostProcessMiddleware {\n  inspect(originalDom: HTMLElement) {\n    const imgPreloads = []\n    const imgElements = originalDom.querySelectorAll('img')\n    let eligibleImages: Array<HTMLElement> = []\n    for (let i = 0; i < imgElements.length; i++) {\n      if (isImgEligible(imgElements[i])) {\n        eligibleImages.push(imgElements[i])\n      }\n      if (eligibleImages.length >= MAXIMUM_IMAGE_PRELOADS) {\n        break\n      }\n    }\n\n    for (const imgEl of eligibleImages) {\n      const src = imgEl.getAttribute('src')\n      if (src) {\n        imgPreloads.push(src)\n      }\n    }\n\n    return imgPreloads\n  }\n  mutate = async (markup: string, imgPreloads: string[]) => {\n    let result = markup\n    let imagePreloadTags = imgPreloads\n      .filter((imgHref) => !preloadTagAlreadyExists(markup, imgHref))\n      .reduce(\n        (acc, imgHref) =>\n          acc + `<link rel=\"preload\" href=\"${imgHref}\" as=\"image\"/>`,\n        ''\n      )\n    return result.replace(\n      /<link rel=\"preload\"/,\n      `${imagePreloadTags}<link rel=\"preload\"`\n    )\n  }\n}\n\nfunction isImgEligible(imgElement: HTMLElement): boolean {\n  let imgSrc = imgElement.getAttribute('src')\n  return (\n    !!imgSrc &&\n    sourceIsSupportedType(imgSrc) &&\n    imageIsNotTooSmall(imgElement) &&\n    imageIsNotHidden(imgElement)\n  )\n}\n\nfunction preloadTagAlreadyExists(html: string, href: string) {\n  const escapedHref = escapeRegexp(href)\n  const regex = new RegExp(`<link[^>]*href[^>]*${escapedHref}`)\n  return html.match(regex)\n}\n\nfunction imageIsNotTooSmall(imgElement: HTMLElement): boolean {\n  // Skip images without both height and width--we don't know enough to say if\n  // they are too small\n  if (\n    !(imgElement.hasAttribute('height') && imgElement.hasAttribute('width'))\n  ) {\n    return true\n  }\n  try {\n    const heightAttr = imgElement.getAttribute('height')\n    const widthAttr = imgElement.getAttribute('width')\n    if (!heightAttr || !widthAttr) {\n      return true\n    }\n\n    if (\n      parseInt(heightAttr) * parseInt(widthAttr) <=\n      IMAGE_PRELOAD_SIZE_THRESHOLD\n    ) {\n      return false\n    }\n  } catch (err) {\n    return true\n  }\n  return true\n}\n\n// Traverse up the dom from each image to see if it or any of it's\n// ancestors have the hidden attribute.\nfunction imageIsNotHidden(imgElement: HTMLElement): boolean {\n  let activeElement = imgElement\n  while (activeElement.parentNode) {\n    if (activeElement.hasAttribute('hidden')) {\n      return false\n    }\n    activeElement = activeElement.parentNode as HTMLElement\n  }\n  return true\n}\n\n// Currently only filters out svg images--could be made more specific in the future.\nfunction sourceIsSupportedType(imgSrc: string): boolean {\n  return !imgSrc.includes('.svg')\n}\n\n// Initialization\nregisterPostProcessor(\n  'Inline-Fonts',\n  new FontOptimizerMiddleware(),\n  // Using process.env because passing Experimental flag through loader is not possible.\n  // @ts-ignore\n  (options) => options.optimizeFonts || process.env.__NEXT_OPTIMIZE_FONTS\n)\n\nregisterPostProcessor(\n  'Preload Images',\n  new ImageOptimizerMiddleware(),\n  // @ts-ignore\n  (options) => options.optimizeImages || process.env.__NEXT_OPTIMIZE_IMAGES\n)\n\nexport default processHTML\n"]},"metadata":{},"sourceType":"script"}